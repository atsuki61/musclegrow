---
alwaysApply: true
description: MuscleGrow筋トレ記録アプリのプロジェクト固有設定：技術スタック、コーディングスタイル、ディレクトリ構造、コア機能実装ルール
---

# プロジェクト: MuscleGrow 筋トレ記録アプリ

## 概要

- **目的**: 筋トレ習慣を可視化し、継続的なモチベーションを提供する Web アプリ
- **コンセプト**: 筋トレ記録を可視化し、自分の成長を直感的に把握
- **対象ユーザー**: 筋トレを継続したい個人、自分の成長を可視化してモチベを維持したい人

## 技術スタック

- **フレームワーク**: Next.js 15.5.7 (App Router)
- **言語**: TypeScript 5.9.3
- **UI**: Tailwind CSS 4.1.16 + shadcn/ui (Radix UI ベース)
- **データベース**: Supabase (PostgreSQL)
- **認証**: Better Auth 1.3.34（メール/パスワード + Google OAuth）
- **ORM**: Drizzle ORM 0.44.7
- **バリデーション**: Zod 4.1.12
- **グラフ**: Recharts 3.4.1
- **アニメーション**: framer-motion 12.23.24
- **パッケージ管理**: pnpm
- **ホスティング**: Vercel

## コーディングスタイル

- **関心の分離**: 再利用可能なコンポーネント設計
- **App Router 規約**: `page.tsx`, `layout.tsx`, `loading.tsx`, `error.tsx` などに従う
- **TypeScript**: 厳格な型定義、`any`の使用禁止
- **Tailwind**: ユーティリティファースト、インラインスタイルは避ける
- **モバイルファースト**: スマホアプリ風の UI 設計

### 開発設計ルール

#### 設計原則

- **関心の分離**: 影響範囲を限定する
- **高凝集**: 内部変更を容易にする
- **疎結合**: 依存関係を減らす
- **抽象化**: 変更耐性を高める
- **非冗長**: 重複を排除する

#### ディレクトリ構造管理

- 同一関心のファイルが 3 件以上になった場合は専用ディレクトリを作成し階層化する

#### 実装指針

- **シンプルを最優先**: オーバーエンジニアリング禁止
- **最小限の設計・実装**: 常に必要最小限で実装する
- **適切な粒度**: ファイルの細分化を避ける。過剰な場合は統合する

### UI コンポーネント実装ルール（shadcn/ui 使用必須）

**【最重要】すべての UI コンポーネントは shadcn/ui を使用すること**

#### shadcn/ui 使用の原則

1. **コンポーネント追加時の必須手順**:

   - 新しい UI コンポーネントが必要な場合、まず shadcn/ui レジストリを確認
   - 利用可能なコンポーネントがあれば、必ず shadcn/ui を使用
   - カスタムコンポーネントは shadcn/ui で実装できない場合のみ作成

2. **shadcn/ui MCP サーバーの活用**:

   - `pnpx shadcn@latest add <component>` でコンポーネントを追加
   - または MCP サーバー経由で「<component>コンポーネントを追加して」とリクエスト

3. **利用可能な主要コンポーネント**:

   - フォーム: `button`, `input`, `textarea`, `select`, `checkbox`, `radio-group`, `switch`, `label`, `form`
   - レイアウト: `card`, `separator`, `sheet`, `dialog`, `drawer`, `tabs`, `accordion`
   - フィードバック: `alert`, `toast`, `progress`, `skeleton`, `badge`
   - ナビゲーション: `navigation-menu`, `dropdown-menu`, `menubar`, `breadcrumb`
   - データ表示: `table`, `avatar`, `calendar`, `chart`
   - その他: `tooltip`, `popover`, `context-menu`, `command`, `scroll-area`

4. **shadcn/ui コンポーネントのカスタマイズ**:

   - `src/components/ui/` に追加されたコンポーネントは必要に応じてカスタマイズ可能
   - ただし、基本構造と variant システムは維持すること
   - カスタマイズは Tailwind クラスで行い、インラインスタイルは避ける

5. **禁止事項**:

   - shadcn/ui で実装可能なのに、独自の UI コンポーネントを作成すること
   - 生の HTML 要素（`<button>`, `<input>` など）を直接使用すること（shadcn/ui の Button, Input を使用）
   - サードパーティの UI ライブラリを shadcn/ui の代わりに使用すること

6. **実装例**:

```typescript
// ❌ 悪い例: 生のHTML要素を使用
<button className="px-4 py-2 bg-blue-500 text-white rounded">クリック</button>;

// ✅ 良い例: shadcn/ui の Button を使用
import { Button } from "@/components/ui/button";

<Button variant="default" size="default">
  クリック
</Button>;
```

```typescript
// ❌ 悪い例: カスタムダイアログを作成
const CustomDialog = () => {
  return <div className="fixed inset-0 bg-black/50">...</div>;
};

// ✅ 良い例: shadcn/ui の Dialog を使用
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";

<Dialog>
  <DialogTrigger>開く</DialogTrigger>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>タイトル</DialogTitle>
      <DialogDescription>説明</DialogDescription>
    </DialogHeader>
  </DialogContent>
</Dialog>;
```

### 初学者向けコード品質ルール

#### 実装範囲の制限（最重要）

- **1 回の実装は必ず小さく分割**: 1 つの機能、1 つのコンポーネント、1 つの関数のみを実装
- **段階的実装**: まず最小限の動作するコードを作成し、その後機能を追加
- **理解可能な単位**: コードの各行が何をしているかを明確に説明できるレベルで実装
- **1 ファイルあたりの変更**: 原則として 1 ファイルのみを変更し、複数ファイルにまたがる変更は分割

#### 読みやすいコードの原則

- **明示的な命名**: 変数名・関数名は処理内容が一目で分かるように命名
- **コメントの充実**: 複雑な処理には必ずコメントを記述
- **1 つの責任**: 1 つの関数・コンポーネントは 1 つの責任のみを持つ
- **適切な分割**: 長い関数（20 行以上）は分割を検討
- **定数の使用**: マジックナンバーは定数として定義

#### 初学者が理解しやすい実装パターン

```typescript
// ❌ 複雑な例（初学者には理解困難）
const processData = (data: unknown[]) =>
  data
    .filter((item) => typeof item === "object" && item !== null && "id" in item)
    .map((item) => ({ ...item, processed: true }));

// ✅ 初学者向けの例（段階的で理解しやすい）
const isValidItem = (item: unknown): boolean => {
  return typeof item === "object" && item !== null && "id" in item;
};

const addProcessedFlag = (item: Record<string, unknown>) => {
  return { ...item, processed: true };
};

const processData = (data: unknown[]) => {
  // 1. 有効なアイテムのみをフィルタリング
  const validItems = data.filter(isValidItem);

  // 2. 処理済みフラグを追加
  const processedItems = validItems.map(addProcessedFlag);

  return processedItems;
};
```

#### 実装順序の指針

1. **型定義から開始**: まず必要な型を定義
2. **基本構造**: 最小限の動作する構造を作成
3. **機能追加**: 段階的に機能を追加
4. **リファクタリング**: 動作確認後にコードを整理

### useEffect 使用ポリシー

useEffect は外部世界との同期のためだけに使用すること。
例: API 呼び出し、WebSocket 接続、ブラウザ API、外部ストアの購読、タイマー。
それ以外のケースでは使用してはならない。

#### アンチパターン

- props や派生値をローカル state にコピーする
- フラグの変更に応じてロジックを実行する
- イベントハンドラの代わりに effect 内でユーザーアクションを処理する
- effect 内で派生値やバリデーション state を更新する
- 空の依存配列で一度だけ初期化を行う（代わりに useMemo を使用）

#### 原則

1. props や state から値を導出できる場合は、レンダリング中に計算すること。
2. ユーザーアクションはイベントハンドラで処理し、effect では処理しないこと。
3. effect は外部システムに触れる本当の副作用のためだけに使用すること。
4. useEffect を書くときは必ず、どの外部リソースと同期しているかを説明する短いコメントを追加すること。

## ディレクトリ構造

```
src/
├── app/                          # Next.js App Router
│   ├── (auth)/                  # 認証関連ページ
│   │   ├── login/               # ログインページ
│   │   └── signup/              # サインアップページ
│   ├── (protected)/             # 認証必須ページ
│   │   ├── goals/               # 目標設定
│   │   ├── history/             # 履歴画面
│   │   ├── profile/             # プロフィール
│   │   ├── record/              # 記録画面
│   │   └── stats/               # 統計・グラフ
│   ├── (static)/                # 静的ページ
│   │   ├── contact/             # お問い合わせ
│   │   ├── privacy/             # プライバシーポリシー
│   │   └── terms/               # 利用規約
│   ├── api/                     # API ルート
│   │   ├── auth/                # 認証API（Better Auth）
│   │   ├── check-env/            # 環境チェック
│   │   └── profile/             # プロフィールAPI
│   ├── layout.tsx                # ルートレイアウト
│   └── page.tsx                 # ホーム画面
├── components/                   # React コンポーネント
│   ├── features/                # 機能別コンポーネント
│   │   ├── goals/               # 目標設定関連
│   │   ├── history/             # 履歴関連
│   │   ├── home/                # ホーム画面関連
│   │   ├── profile/             # プロフィール関連
│   │   ├── record/              # 記録関連
│   │   ├── stats/               # 統計・グラフ関連
│   │   └── timer/               # タイマー機能
│   ├── layout/                  # レイアウトコンポーネント
│   │   ├── header.tsx           # ヘッダー
│   │   └── footer-nav.tsx      # フッターナビゲーション
│   ├── ui/                      # shadcn/ui コンポーネント
│   └── theme-provider.tsx       # テーマプロバイダー
├── lib/                         # ユーティリティ・ロジック
│   ├── actions/                 # サーバーアクション
│   │   ├── big3-progress.ts
│   │   ├── cardio-records.ts
│   │   ├── data-export.ts
│   │   ├── exercises.ts
│   │   ├── history.ts
│   │   ├── profile.ts
│   │   ├── sets.ts
│   │   ├── settings.ts
│   │   ├── stats.ts
│   │   ├── user-exercises.ts
│   │   └── workout-sessions.ts
│   ├── utils/                   # ユーティリティ関数
│   │   ├── bmi.ts
│   │   ├── body-composition.ts
│   │   └── stats.ts
│   ├── auth.ts                  # 認証設定（Better Auth）
│   ├── auth-client.ts           # クライアント認証
│   ├── auth-guard.tsx           # 認証ガード
│   ├── auth-session-context.tsx # セッションコンテキスト
│   ├── auth-session-server.ts   # サーバーセッション
│   ├── data-source.ts           # データソース管理
│   ├── local-storage-*.ts       # localStorage 管理（ゲストモード）
│   └── validations.ts           # バリデーション
├── hooks/                       # カスタムフック
│   ├── use-cardio-session.ts
│   ├── use-last-trained.ts
│   ├── use-max-weights.ts
│   ├── use-previous-record.ts
│   ├── use-theme-colors.ts
│   └── use-workout-session.ts
├── types/                       # TypeScript型定義
│   ├── profile.ts
│   ├── stats.ts
│   └── workout.ts
└── supabase/                    # Supabase設定
    ├── browser-client.ts        # ブラウザクライアント
    └── server-client.ts         # サーバークライアント
```

## コア機能実装ルール

### 1. ホーム画面（実装済み）

- Big3（ベンチプレス、スクワット、デッドリフト）の進捗バー表示
- 目標達成率の可視化
- 週間ストリーク表示
- 総トレーニング日数の表示
- 記録ボタン（クイックアクセス）

### 2. 記録機能（実装済み）

- トレーニング記録の追加（日付・部位・種目・重量・回数・メモ）
- カーディオ記録の追加
- 前回記録の自動表示（同じ種目の場合）
- カスタム種目の追加
- リアルタイム保存（Supabase / localStorage）
- バリデーション: 必須項目チェック、数値範囲チェック

### 3. 履歴画面（実装済み）

- カレンダー形式での記録表示
- 過去の記録一覧（日別・週別）
- 部位別フィルタリング機能
- 種目ごとの履歴表示
- 削除・編集機能（スワイプ操作対応）
- 記録の共有機能（画像生成）

### 4. 統計・グラフ画面（実装済み）

- 種目ごとの重量・回数推移グラフ
- 体組成の推移グラフ
- 成長の推移を時系列で確認
- 各種統計情報の表示

### 5. プロフィール画面（実装済み）

- 身長・体重・体脂肪率・筋肉量の記録
- Big3 の目標値設定
- アカウント設定（メール変更、パスワード変更、アカウント削除）
- テーマカラーの変更
- ゲストデータの移行機能

### 6. 認証機能（実装済み）

- メール/パスワード認証
- Google OAuth 認証
- ゲストモード（localStorage 使用）
- ゲストデータの自動移行（会員登録時）
- セッション管理

### 7. その他の機能（実装済み）

- インターバルタイマー
- データエクスポート（CSV 形式）
- ダークモード対応
- レスポンシブデザイン（モバイルファースト）

## TypeScript 型安全性ルール

### any 禁止ポリシー

- 原則として `any` の使用を禁止
- 例外の場合は対象行に限定した無効化と理由コメントを必須
- 代替案:
  - 不明な値: `unknown`
  - 任意のオブジェクト: `Record<string, unknown>`
  - 外部入力: スキーマバリデーション（Zod）で検証

### エラーハンドリング

```ts
try {
  /* ... */
} catch (e: unknown) {
  if (e instanceof Error) {
    console.error(e.message);
  } else {
    console.error("Unknown error", e);
  }
}
```

## Supabase 連携ルール

### データベース設計

- Drizzle ORM による型安全なスキーマ定義
- ユーザーごとのデータ分離（RLS 有効）
- 正規化されたテーブル設計
- 適切なインデックス設定
- マイグレーション管理（Drizzle Kit）

### 認証フロー

- Better Auth による認証管理
- Drizzle Adapter を使用したデータベース連携
- メール/パスワード + Google OAuth 対応
- セッション管理（Next.js Cookies）
- プロテクトされたルート（`(protected)` グループ）

### データ管理

- ハイブリッドデータ管理: Supabase（認証済みユーザー）+ localStorage（ゲストモード）
- ゲストデータの自動移行機能
- トランザクション処理による整合性担保

## UI/UX 設計原則

### モバイルファースト

- タッチ操作に最適化
- 直感的なナビゲーション
- 読みやすいフォントサイズ

### 色による視覚的分離

- 部位別カラーコード統一
- 進捗状況の色分け
- アクセシビリティ配慮

### パフォーマンス

- 初期ロード < 3 秒
- 画像最適化
- コード分割

## 重要なプロジェクトファイル

- **ルートレイアウト**: [src/app/layout.tsx](mdc:src/app/layout.tsx)
- **グローバルスタイル**: [src/app/globals.css](mdc:src/app/globals.css)
- **認証設定**: [src/lib/auth.ts](mdc:src/lib/auth.ts)
- **Supabase 設定**: [src/supabase/](mdc:src/supabase/)
- **データベーススキーマ**: [db/schemas/](mdc:db/schemas/)
- **要件定義**: [docx/要件定義.md](mdc:docx/要件定義.md)
- **README**: [README.md](mdc:README.md)

## コミット粒度の原則

- **原則**: 1 コミット = 1 意図。テスト / ビルドが通る状態を保ち、不要変更は含めない
- **変更ファイルが複数ある場合**: 原則として「ファイル単位」で個別コミットすること
  - 例外: 同一の単一意図に厳密に属する微小変更は 1 コミットにまとめて可（ただしメッセージで範囲を明記）
  - 推奨手順: `git add <file>` → 適切なスコープ付きメッセージで `git commit -m "feat(scope): 内容"` をファイルごとに実行

### 推奨コミット粒度例

- ルート/フッター更新
- レイアウト追加（Header/PageHeader/Footer）
- ページシェル追加（薄い page.tsx）
- コンポーネント追加（UI）
- フック/ユーティリティ追加（ロジック）
- ドキュメント（README.md、要件定義.md）
- 設定ファイル（package.json、tsconfig.json）
- Supabase 設定（migration、schema）
